name: CI

on:
  push:
    branches: [main, add-actions-workflows]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  lint:
    name: Lint & Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up mise
        uses: jdx/mise-action@v2
        with:
          cache: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Restore build cache
        uses: actions/cache@v4
        with:
          path: .build-cache
          key: build-cache-v1-${{ runner.os }}-${{ hashFiles('openapi/**/*.yaml', 'changelog/entries/**/*.md', 'package.json', 'pnpm-lock.yaml', 'scripts/**/*.{mjs,ts}', 'docs/**/*.{md,mdx}', 'src/**/*.{ts,tsx,js,jsx}', 'docusaurus.config.ts', 'sidebars.ts') }}
          restore-keys: |
            build-cache-v1-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check for incorrect support email
        run: |
          echo "Checking for usage of support@glean.com..."
          if grep -r --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=build --exclude-dir=dist --exclude-dir=.next --exclude="*.lock" --exclude="pnpm-lock.yaml" --exclude="ci.yml" "support@glean.com" .; then
            echo "Found usage of incorrect email 'support@glean.com'"
            echo "Please replace with the correct support email address"
            exit 1
          else
            echo "No usage of support@glean.com found"
          fi

  build:
    name: Build Site
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up mise
        uses: jdx/mise-action@v2
        with:
          cache: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build website
        run: pnpm build

      - name: Upload build artifact
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: build/
          retention-days: 1

  visual-regression:
    name: Visual Regression Tests
    needs: build
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/visual-regression.yml
    with:
      pr-number: ${{ github.event.pull_request.number }}
      commit-sha: ${{ github.event.pull_request.head.sha }}
